<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aviator Pro - Real Database</title>
    
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d1117">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/7893/7893979.png">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           1. CORE CSS (FULL GRAPHICS VERSION)
           ========================================= */
        :root {
            --bg-dark: #0d1117;
            --bg-panel: #161b22;
            --bg-card: #21262d;
            --border: #30363d;
            --text-main: #c9d1d9;
            --text-muted: #8b949e;
            --accent: #e91e63;
            --win: #2ea043;
            --loss: #e74c3c;
            --gold: #f1e05a;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            background-color: var(--bg-dark); 
            color: white; 
            font-family: 'Roboto', sans-serif; 
            margin: 0; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        /* =========================================
           2. HEADER
           ========================================= */
        .header { 
            height: 64px; 
            background: var(--bg-panel); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 24px; 
            border-bottom: 1px solid var(--border); 
            z-index: 100; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
        }

        .brand { 
            font-size: 26px; font-weight: 900; color: var(--accent); font-style: italic; 
            letter-spacing: -1px; display: flex; align-items: center; gap: 8px;
            text-shadow: 0 0 15px rgba(233, 30, 99, 0.4); 
        }
        
        .brand span {
            font-size: 11px; background: linear-gradient(45deg, #ff0055, #ff5500);
            color: white; padding: 3px 6px; border-radius: 4px; font-style: normal;
            letter-spacing: 0.5px; box-shadow: 0 2px 8px rgba(255, 0, 85, 0.4);
        }

        .header-controls { display: flex; gap: 12px; align-items: center; }

        .wallet-pill { 
            background: #238636; padding: 6px 16px; border-radius: 50px; font-weight: bold; 
            font-size: 15px; color: white; cursor: pointer; display: flex; align-items: center; 
            gap: 10px; box-shadow: 0 0 20px rgba(35, 134, 54, 0.3); 
            border: 1px solid rgba(255,255,255,0.1); transition: transform 0.2s; 
        }
        .wallet-pill:active { transform: scale(0.96); }

        .menu-btn { 
            background: var(--bg-card); border: 1px solid var(--border); width: 40px; height: 40px; 
            border-radius: 8px; color: var(--text-muted); cursor: pointer; font-size: 20px; 
            display: flex; justify-content: center; align-items: center; transition: 0.2s;
        }
        .menu-btn:hover { background: #30363d; color: white; }

        /* =========================================
           3. LANDING / LOGIN SCREEN
           ========================================= */
        #landing-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: radial-gradient(circle at center, #1f2937 0%, #0d1117 80%); 
            z-index: 5000; display: flex; flex-direction: column; justify-content: center; 
            align-items: center; text-align: center; 
        }
        .landing-logo { 
            font-size: 72px; font-weight: 900; color: var(--accent); margin-bottom: 40px; 
            font-style: italic; text-shadow: 0 0 30px rgba(233, 30, 99, 0.6); 
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .landing-box { 
            background: rgba(22, 27, 34, 0.9); backdrop-filter: blur(10px);
            padding: 40px; border-radius: 24px; width: 90%; max-width: 400px; 
            border: 1px solid var(--border); box-shadow: 0 20px 60px rgba(0,0,0,0.5); 
        }
        .landing-btn { 
            width: 100%; padding: 16px; margin: 10px 0; border-radius: 12px; border: none; 
            font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; 
            display: flex; align-items: center; justify-content: center; gap: 10px; text-transform: uppercase; 
        }
        .btn-web { background: transparent; border: 2px solid var(--border); color: white; }
        .btn-web:hover { border-color: var(--text-muted); background: var(--bg-card); }
        .btn-app { background: linear-gradient(135deg, #e91e63, #c2185b); color: white; box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4); display: none; }
        
        .login-input {
            width: 100%; padding: 14px; background: #0d1117; border: 1px solid #30363d;
            color: white; border-radius: 8px; font-size: 16px; text-align: center; 
            margin-bottom: 20px; font-weight: bold; letter-spacing: 1px;
        }

        /* =========================================
           4. GAME LAYOUT
           ========================================= */
        #game-container { display: none; height: 100%; width: 100%; }
        .game-grid { display: flex; height: calc(100vh - 64px); width: 100%; }
        
        .sidebar-col { width: 280px; background: var(--bg-dark); display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .sidebar-right { border-right: none; border-left: 1px solid var(--border); }
        
        .panel-header { 
            padding: 12px 16px; background: var(--bg-panel); font-size: 12px; color: var(--text-muted); 
            border-bottom: 1px solid var(--border); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .scroll-list { overflow-y: auto; flex: 1; padding: 0; }
        
        .bet-row { 
            display: flex; justify-content: space-between; padding: 8px 16px; font-size: 13px; 
            border-bottom: 1px solid #21262d; color: var(--text-main); align-items: center; 
            background: var(--bg-dark); transition: 0.2s;
        }
        .bet-row:nth-child(even) { background: #12161c; }
        .bet-row.winner { background: rgba(46, 204, 113, 0.1); border-left: 3px solid var(--win); }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 24px; height: 24px; background: var(--bg-card); border-radius: 50%; display: grid; place-items: center; font-size: 12px; color: #aaa; }
        
        .chat-msg { padding: 8px 12px; font-size: 13px; line-height: 1.4; border-bottom: 1px solid rgba(48, 54, 61, 0.5); }
        .chat-u { color: #58a6ff; font-weight: bold; margin-right: 4px; cursor: pointer; }
        .chat-t { color: var(--text-main); }
        
        @media (max-width: 900px) { .sidebar-col { display: none; } }

        /* =========================================
           5. CANVAS & ANIMATIONS
           ========================================= */
        .stage { flex: 1; display: flex; flex-direction: column; position: relative; background: #010409; }
        
        .history-strip { 
            height: 48px; background: var(--bg-dark); display: flex; align-items: center; gap: 8px; 
            padding: 0 16px; overflow-x: auto; border-bottom: 1px solid var(--border); 
            scrollbar-width: none;
        }
        .pill { 
            padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; 
            background: rgba(255,255,255,0.05); color: #ccc; border: 1px solid transparent; flex-shrink: 0; 
        }
        .pill.win { color: var(--win); background: rgba(46, 204, 113, 0.1); border-color: rgba(46, 204, 113, 0.2); }
        .pill.lose { color: #58a6ff; background: rgba(88, 166, 255, 0.1); border-color: rgba(88, 166, 255, 0.2); }
        .pill.jackpot { color: var(--accent); background: rgba(233, 30, 99, 0.1); border-color: var(--accent); box-shadow: 0 0 10px rgba(233,30,99,0.2); }

        .canvas-area { flex: 1; position: relative; overflow: hidden; cursor: crosshair; }
        canvas { width: 100%; height: 100%; display: block; }
        
        .overlay-center { 
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); 
            text-align: center; width: 100%; pointer-events: none; 
        }
        .multiplier-big { 
            font-size: 96px; font-weight: 900; color: white; text-shadow: 0 0 50px rgba(0,0,0,0.8); 
            font-variant-numeric: tabular-nums; 
        }
        .status-badge { 
            font-size: 18px; color: var(--text-muted); margin-bottom: 15px; letter-spacing: 3px; 
            text-transform: uppercase; font-weight: bold; background: rgba(0,0,0,0.5); 
            padding: 8px 16px; border-radius: 50px; display: inline-block;
        }
        
        .loader-bar { width: 240px; height: 6px; background: var(--bg-card); margin: 20px auto; border-radius: 3px; overflow: hidden; display: none; }
        .loader-fill { width: 0%; height: 100%; background: var(--accent); border-radius: 3px; box-shadow: 0 0 15px var(--accent); transition: width 0.1s linear; }

        .win-popup { 
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%) scale(0); 
            background: rgba(46, 204, 113, 0.95); color: #fff; padding: 24px 48px; border-radius: 60px; 
            font-size: 36px; font-weight: 900; box-shadow: 0 0 60px rgba(46, 204, 113, 0.5); 
            pointer-events: none; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            border: 4px solid #fff; z-index: 1000; text-align: center; 
        }

        /* =========================================
           6. BETTING CONTROLS
           ========================================= */
        .controls-deck { 
            height: auto; min-height: 140px; background: var(--bg-panel); border-top: 1px solid var(--border); 
            display: flex; justify-content: center; align-items: center; gap: 16px; padding: 16px; flex-wrap: wrap;
        }

        .bet-interface { 
            width: 380px; background: var(--bg-card); border: 1px solid var(--border); 
            border-radius: 16px; padding: 12px; display: flex; align-items: center; 
            justify-content: space-between; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .bet-interface::before { content: ''; position: absolute; top: 4px; left: 4px; width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .bet-interface.active::before { background: var(--win); box-shadow: 0 0 5px var(--win); }

        .bet-col { display: flex; flex-direction: column; gap: 8px; align-items: center; width: 62%; }
        
        .amount-group { 
            display: flex; width: 100%; gap: 6px; background: var(--bg-dark); 
            padding: 4px; border-radius: 10px; border: 1px solid var(--border); 
        }
        .raw-input { 
            flex: 1; background: transparent; border: none; color: white; text-align: center; 
            font-weight: bold; font-size: 18px; padding: 8px; outline: none; font-family: 'Roboto', monospace;
        }
        
        .big-btn { 
            width: 120px; height: 74px; border-radius: 12px; border: none; font-size: 18px; 
            font-weight: 900; color: white; cursor: pointer; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; transition: all 0.1s; 
            text-transform: uppercase; line-height: 1.2; position: relative; top: 0;
        }
        
        .btn-green { background: linear-gradient(180deg, #2ea043 0%, #238636 100%); box-shadow: 0 4px 0 #1a6328; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .btn-green:active:not(:disabled) { top: 4px; box-shadow: 0 0 0 #1a6328; }
        
        .btn-orange { background: linear-gradient(180deg, #f1e05a 0%, #d29922 100%); color: #24292f; text-shadow: none; box-shadow: 0 4px 0 #9e731a; }
        .btn-orange:active:not(:disabled) { top: 4px; box-shadow: 0 0 0 #9e731a; }
        
        .btn-red { background: linear-gradient(180deg, #fa7a7a 0%, #da3633 100%); box-shadow: 0 4px 0 #a02825; }
        .btn-disabled { background: #353b43; color: #6e7681; cursor: not-allowed; box-shadow: none; opacity: 0.8; }

        .chip-row { display: flex; gap: 6px; width: 100%; justify-content: center; }
        .chip { 
            background: var(--bg-panel); border: 1px solid var(--border); padding: 6px 0; 
            font-size: 11px; border-radius: 6px; cursor: pointer; color: var(--text-muted); 
            transition: 0.2s; flex: 1; text-align: center; font-weight: bold; 
        }
        .chip:hover { background: #58a6ff; color: white; border-color: #58a6ff; }
        .chip:active { transform: scale(0.95); }

    </style>
</head>
<body>

    <div id="win-popup" class="win-popup">
        <span class="win-sub" style="display:block; font-size:14px; opacity:0.8; margin-bottom:5px;">YOU WON</span>
        <div id="win-amount">‚Çπ0.00</div>
    </div>

    <div id="landing-screen">
        <div class="landing-logo">‚úàÔ∏è AVIATOR</div>
        <div class="landing-box">
            <p style="color:#aaa; margin-bottom:25px; font-size:14px;">Secure Database Connection ‚Ä¢ v5.0 Pro</p>
            
            <input type="text" id="username-input" class="login-input" placeholder="Enter Username (e.g. Tarun)" maxlength="12">
            <button class="landing-btn btn-app" style="display:flex; background:#238636;" onclick="handleLogin()">üöÄ LOGIN & PLAY</button>
            
            <p id="conn-status" style="margin-top:20px; color:#555; font-size:12px;">Connecting to server...</p>
        </div>
        <p style="position: absolute; bottom: 20px; color: #555; font-size: 11px;">System Status: <span style="color:#2ea043">‚óè Online</span></p>
    </div>

    <div id="game-container">
        <div class="header">
            <div class="brand">
                AVIATOR <span>DB</span>
            </div>
            <div class="header-controls">
                <div class="wallet-pill">
                    <span style="color:#8b949e; font-weight:normal;">Balance:</span>
                    ‚Çπ <span id="balance-el">0.00</span>
                    <div style="width:20px; height:20px; background:rgba(255,255,255,0.2); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px;">+</div>
                </div>
                <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
            </div>
        </div>

        <div class="game-grid">
            <div class="sidebar-col">
                <div class="panel-header">
                    <span>All Bets</span>
                    <span style="color:#2ea043; background:rgba(46,204,113,0.1); padding:2px 6px; border-radius:4px;" id="total-players">0</span>
                </div>
                <div class="scroll-list" id="bot-list"></div>
                <div style="padding:10px; font-size:11px; color:#555; text-align:center; border-top:1px solid #21262d;">
                    Server Hash: <span style="font-family:monospace">af82...9d1</span>
                </div>
            </div>

            <div class="stage">
                <div class="history-strip" id="history-bar"></div>
                
                <div class="canvas-area">
                    <canvas id="gameCanvas"></canvas>
                    
                    <div class="overlay-center">
                        <div class="loader-bar" id="loader-bar"><div class="loader-fill" id="loader-fill"></div></div>
                        <div class="status-badge" id="status-text">CONNECTING...</div>
                        <div class="multiplier-big" id="multiplier-text">1.00x</div>
                    </div>
                </div>

                <div class="controls-deck">
                    <div class="bet-interface" id="panel-1">
                        <div class="bet-col">
                            <div class="amount-group">
                                <button class="chip" onclick="adjBet(1, -10)">‚àí</button>
                                <input type="number" id="input-1" class="raw-input" value="10">
                                <button class="chip" onclick="adjBet(1, 10)">+</button>
                            </div>
                            <div class="chip-row">
                                <div class="chip" onclick="setBet(1, 100)">100</div>
                                <div class="chip" onclick="setBet(1, 500)">500</div>
                                <div class="chip" onclick="setBet(1, 1000)">1K</div>
                                <div class="chip" onclick="setBet(1, 5000)">5K</div>
                            </div>
                        </div>
                        <button id="btn-1" class="big-btn btn-green" onclick="handleAction(1)">BET</button>
                    </div>

                    <div class="bet-interface" id="panel-2">
                        <div class="bet-col">
                            <div class="amount-group">
                                <button class="chip" onclick="adjBet(2, -10)">‚àí</button>
                                <input type="number" id="input-2" class="raw-input" value="50">
                                <button class="chip" onclick="adjBet(2, 10)">+</button>
                            </div>
                            <div class="chip-row">
                                <div class="chip" onclick="setBet(2, 100)">100</div>
                                <div class="chip" onclick="setBet(2, 500)">500</div>
                                <div class="chip" onclick="setBet(2, 1000)">1K</div>
                                <div class="chip" onclick="setBet(2, 5000)">5K</div>
                            </div>
                        </div>
                        <button id="btn-2" class="big-btn btn-green" onclick="handleAction(2)">BET</button>
                    </div>
                </div>
            </div>

            <div class="sidebar-col sidebar-right">
                <div class="panel-header"><span>Live Chat</span><span>üü¢</span></div>
                <div class="scroll-list" id="chat-list" style="padding:10px;">
                    <div class="chat-msg"><span class="chat-u" style="color:#e91e63">System:</span> Welcome to the Real Money Server.</div>
                </div>
                <div style="padding:10px; border-top:1px solid #30363d;">
                    <input type="text" placeholder="Type a message..." style="width:100%; background:#0d1117; border:1px solid #30363d; padding:8px; color:white; border-radius:6px;">
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. SETUP & VARIABLES
        // ==========================================
        const socket = io(); // Connect to Node.js Server
        
        // User Data (From DB)
        let currentUser = null;
        let currentBalance = 0;
        let userHistory = [];

        // Game State
        let gameState = "IDLE";
        let multiplier = 1.00;
        let particles = [];
        
        // Audio
        let audioCtx, engineOsc, engineGain;

        // Bets
        let bets = [
            { id: 1, active: false, cashed: false, amount: 0, btn: document.getElementById('btn-1'), inp: document.getElementById('input-1'), panel: document.getElementById('panel-1') },
            { id: 2, active: false, cashed: false, amount: 0, btn: document.getElementById('btn-2'), inp: document.getElementById('input-2'), panel: document.getElementById('panel-2') }
        ];

        // ==========================================
        // 2. SOCKET LISTENERS (REAL DATA)
        // ==========================================
        
        socket.on("connect", () => {
            document.getElementById('conn-status').innerText = "Server Online ‚úÖ";
            document.getElementById('conn-status').style.color = "#2ea043";
        });

        // Login Success (Receive Balance)
        socket.on('login-success', (data) => {
            currentUser = data.username;
            currentBalance = data.balance;
            userHistory = data.history || [];
            
            document.getElementById('balance-el').innerText = currentBalance.toFixed(2);
            
            // Switch Screens
            document.getElementById('landing-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            
            resize(); 
            initAudio();
        });

        // Balance Update
        socket.on('balance-update', (newBal) => {
            currentBalance = newBal;
            document.getElementById('balance-el').innerText = currentBalance.toFixed(2);
        });

        // Game Loop Sync
        socket.on("welcome", (data) => { syncState(data); });
        socket.on("state-change", (data) => { syncState(data); });

        function syncState(data) {
            if(data.state) gameState = data.state;
            if(data.multiplier) multiplier = data.multiplier;

            if (gameState === "IDLE") {
                resetRoundUI();
                if(data.countdown) document.getElementById('status-text').innerText = `NEXT ROUND: ${data.countdown}s`;
            } else if (gameState === "FLYING") {
                startFlyingUI();
            }
        }

        socket.on("timer-update", (time) => {
            document.getElementById('status-text').innerText = `STARTING IN ${time}s`;
            document.getElementById('status-text').style.color = "white";
            if(time === 0) {
                document.getElementById('status-text').innerText = "PREPARING FLIGHT...";
                document.getElementById('loader-bar').style.display = "block";
                setTimeout(() => document.getElementById('loader-fill').style.width = "100%", 100);
            }
        });

        socket.on("tick", (serverMult) => {
            multiplier = serverMult;
            document.getElementById('multiplier-text').innerText = multiplier.toFixed(2) + "x";
            updateEnginePitch(multiplier);

            // Update Active Buttons
            bets.forEach(b => {
                if(b.active && !b.cashed) {
                    let win = (b.amount * multiplier).toFixed(0);
                    b.btn.innerHTML = `CASH OUT<br><span style="color:#fff; font-size:12px">‚Çπ${win}</span>`;
                }
            });
            draw(); 
        });

        socket.on("crash", (data) => {
            handleCrash(data.multiplier);
        });

        // ==========================================
        // 3. UI STATE MANAGEMENT
        // ==========================================
        function resetRoundUI() {
            gameState = "IDLE";
            multiplier = 1.00;
            particles = [];
            stopEngineSound();

            document.getElementById('multiplier-text').innerText = "1.00x";
            document.getElementById('multiplier-text').style.color = "white";
            document.getElementById('status-text').style.display = "inline-block";
            document.getElementById('status-text').style.background = "rgba(0,0,0,0.5)";
            document.getElementById('loader-bar').style.display = "none";
            document.getElementById('loader-fill').style.width = "0%";
            document.getElementById('win-popup').style.transform = "translate(-50%, -50%) scale(0)";

            bets.forEach(b => {
                b.cashed = false;
                b.panel.classList.remove("active");
                if (b.active) {
                    // Lost (Server already deducted, just reset UI)
                    b.active = false;
                    b.btn.innerText = "BET";
                    b.btn.className = "big-btn btn-green";
                    b.btn.disabled = false;
                } else {
                    b.btn.innerText = "BET";
                    b.btn.className = "big-btn btn-green";
                    b.btn.disabled = false;
                }
            });
            draw();
        }

        function startFlyingUI() {
            gameState = "FLYING";
            document.getElementById('loader-bar').style.display = "none";
            document.getElementById('status-text').style.display = "none";
            startEngineSound();

            bets.forEach(b => {
                if (b.active) {
                    b.btn.innerText = "CASH OUT";
                    b.btn.className = "big-btn btn-orange";
                    b.panel.classList.add("active");
                } else {
                    b.btn.className = "big-btn btn-disabled";
                    b.btn.disabled = true;
                }
            });
        }

        function handleCrash(val) {
            gameState = "CRASHED";
            stopEngineSound();
            playSound('crash');

            let txt = document.getElementById('multiplier-text');
            txt.innerText = val.toFixed(2) + "x";
            txt.style.color = "#e74c3c";

            let badges = document.getElementById('status-text');
            badges.innerText = "FLEW AWAY!";
            badges.style.color = "#e74c3c";
            badges.style.display = "inline-block";
            badges.style.background = "rgba(231, 76, 60, 0.2)";

            // Update History Strip (Local view)
            let c = document.getElementById('history-bar');
            let d = document.createElement('div');
            d.innerText = val.toFixed(2) + "x";
            d.className = val >= 10 ? "pill jackpot" : val >= 2 ? "pill win" : "pill lose";
            c.prepend(d);
            if(c.children.length > 20) c.lastChild.remove();

            bets.forEach(b => {
                b.active = false;
                b.panel.classList.remove("active");
                b.btn.innerText = "ENDED";
                b.btn.className = "big-btn btn-disabled";
                b.btn.disabled = true;
            });
            draw();
        }

        // ==========================================
        // 4. USER ACTIONS (REAL BETTING)
        // ==========================================
        function handleLogin() {
            let u = document.getElementById('username-input').value.trim();
            if(!u) return alert("Enter Username!");
            socket.emit('login', u);
        }

        function handleAction(id) {
            playSound('click');
            if(!audioCtx) initAudio();

            let b = bets[id-1];
            let val = parseFloat(b.inp.value);

            if (gameState === "IDLE") {
                if (!b.active) {
                    // PLACE BET
                    if(val > currentBalance) return alert("Low Balance!");
                    
                    // Optimistic update
                    b.amount = val;
                    b.active = true;
                    b.btn.innerHTML = "WAITING...";
                    b.btn.className = "big-btn btn-red";
                    
                    // Server Call
                    socket.emit('place-bet', { username: currentUser, amount: val });
                } else {
                    // CANCEL (Not implemented in server for simplicity, so just UI reset)
                    b.active = false;
                    b.btn.innerText = "BET";
                    b.btn.className = "big-btn btn-green";
                }
            } else if (gameState === "FLYING") {
                // CASH OUT
                if (b.active && !b.cashed) {
                    b.cashed = true;
                    let win = b.amount * multiplier;
                    
                    // Server Call
                    socket.emit('cash-out', { username: currentUser, winAmount: win });

                    playSound('win');
                    showWinPopup(win);
                    spawnConfetti();

                    b.btn.innerHTML = `WON<br>‚Çπ${win.toFixed(0)}`;
                    b.btn.className = "big-btn btn-green";
                    b.btn.disabled = true;
                    b.panel.classList.remove("active");
                }
            }
        }

        // ==========================================
        // 5. CANVAS DRAWING (WITH CRASH FIX)
        // ==========================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let w, h;

        function resize() {
            w = canvas.parentElement.clientWidth;
            h = canvas.parentElement.clientHeight;
            canvas.width = w;
            canvas.height = h;
            draw();
        }
        window.onresize = resize;

        function draw() {
            // Background
            ctx.clearRect(0, 0, w, h);
            
            // Grid
            ctx.strokeStyle = "rgba(255,255,255,0.05)";
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let i=0; i<w; i+=80) { ctx.moveTo(i, 0); ctx.lineTo(i, h); }
            for (let i=0; i<h; i+=80) { ctx.moveTo(0, i); ctx.lineTo(w, i); }
            ctx.stroke();

            // CRASH FIX: Don't draw plane if crashed
            if (gameState === "CRASHED") return;

            // Plane Math
            let x = (multiplier - 1) * 200; 
            let y = h - ((multiplier - 1) * 200);
            if (x > w - 100) x = w - 100;
            if (y < 100) y = 100;

            // Trail
            ctx.beginPath();
            ctx.moveTo(0, h);
            ctx.quadraticCurveTo(w/3, h, x, y);
            let grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, "rgba(233, 30, 99, 0.5)");
            grad.addColorStop(1, "rgba(233, 30, 99, 0)");
            ctx.fillStyle = grad; ctx.fill();
            ctx.lineWidth = 5; ctx.strokeStyle = "#e91e63"; ctx.stroke();

            // Rocket Body
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(-0.25);
            ctx.fillStyle = "#e91e63"; ctx.beginPath(); ctx.ellipse(0, 0, 40, 14, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#c2185b"; ctx.beginPath(); ctx.moveTo(-15, -8); ctx.lineTo(-35, -20); ctx.lineTo(-25, -8); ctx.fill(); ctx.beginPath(); ctx.moveTo(-15, 8); ctx.lineTo(-35, 20); ctx.lineTo(-25, 8); ctx.fill();
            ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(15, -4, 4, 0, Math.PI*2); ctx.fill();

            // Fire Effect
            if (gameState === "FLYING") {
                let f = Math.random() * 8;
                ctx.fillStyle = "#f1c40f";
                ctx.beginPath(); ctx.moveTo(-35, 0); ctx.lineTo(-60 - f, 8); ctx.lineTo(-50, 0); ctx.lineTo(-60 - f, -8); ctx.fill();
            }
            ctx.restore();

            // Confetti
            if (particles.length > 0) {
                for (let i = particles.length - 1; i >= 0; i--) {
                    let p = particles[i];
                    p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life -= 0.02;
                    ctx.fillStyle = p.color;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                    if (p.life <= 0) particles.splice(i, 1);
                }
            }
        }

        // ==========================================
        // 6. UTILITIES (Sound, Fake Bots, etc.)
        // ==========================================
        function initAudio() { try { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){} }

        function playSound(type) {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);

            if(type==='click'){
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                osc.start(); osc.stop(audioCtx.currentTime+0.05);
            } else if(type==='win') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(440, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(880, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                osc.start(); osc.stop(audioCtx.currentTime+0.5);
            } else if(type==='crash') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime+0.3);
            }
        }

        function startEngineSound() {
            if(!audioCtx) initAudio(); if(engineOsc) return;
            engineOsc = audioCtx.createOscillator(); let g = audioCtx.createGain();
            engineOsc.type = 'sawtooth'; engineOsc.frequency.value = 80; g.gain.value = 0.05;
            engineOsc.connect(g); g.connect(audioCtx.destination); engineOsc.start();
        }

        function updateEnginePitch(m) {
            if(engineOsc) {
                let f = 80 + (m * 50); if(f > 600) f = 600;
                engineOsc.frequency.setTargetAtTime(f, audioCtx.currentTime, 0.1);
            }
        }

        function stopEngineSound() { if(engineOsc) { engineOsc.stop(); engineOsc=null; } }

        function spawnConfetti() {
            for(let i=0; i<40; i++) {
                particles.push({
                    x: w/2, y: h/2,
                    vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15,
                    size: Math.random()*5+2, color: `hsl(${Math.random()*360}, 100%, 50%)`, life: 1
                });
            }
        }

        // --- Fake Bots Logic (Ambience) ---
        const names = ["Aarav","Vivaan","Aditya","Vihaan","Arjun","Sai","Reyansh","Ayaan","Krishna","Ishaan"];
        setInterval(() => {
            if(gameState !== "IDLE") return;
            let list = document.getElementById('bot-list');
            let num = Math.floor(Math.random()*5)+15;
            document.getElementById('total-players').innerText = num;
            
            let html = "";
            let totalBet = 0;
            bets.forEach(b => { if(b.active) totalBet += b.amount; });
            if(totalBet > 0) html += `<div class="bet-row winner" style="border-color:#e91e63"> <div class="user-info"><div class="avatar">You</div> ${currentUser}</div> <div style="color:white">‚Çπ${totalBet}</div> </div>`;

            for(let i=0; i<num; i++) {
                let n = names[i%names.length];
                let amt = (Math.floor(Math.random()*20)+1)*100;
                html += `<div class="bet-row"> <div class="user-info"><div class="avatar">üë§</div> ${n}</div> <div>‚Çπ${amt}</div> </div>`;
            }
            list.innerHTML = html;
        }, 4000);

        // --- Fake Chat Logic ---
        setInterval(() => {
            if(Math.random() > 0.7) {
                let n = names[Math.floor(Math.random()*names.length)];
                let msgs = ["Win!", "Scam", "Big flight coming", "loss :(", "boom", "cashout now", "wait for pink"];
                let m = msgs[Math.floor(Math.random()*msgs.length)];
                let div = document.createElement('div');
                div.className = "chat-msg";
                div.innerHTML = `<span class="chat-u">${n}:</span> <span class="chat-t">${m}</span>`;
                let box = document.getElementById('chat-list');
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
                if(box.children.length > 30) box.firstChild.remove();
            }
        }, 3000);

        // --- Helpers ---
        function adjBet(id, v) { let el=document.getElementById('input-'+id); let n=parseFloat(el.value)+v; if(n<10)n=10; el.value=n; }
        function setBet(id, v) { document.getElementById('input-'+id).value = v; }
        function showWinPopup(a) { 
            let p=document.getElementById('win-popup'); 
            document.getElementById('win-amount').innerText="‚Çπ"+a.toFixed(2); 
            p.style.transform="translate(-50%, -50%) scale(1)"; 
            setTimeout(()=>p.style.transform="translate(-50%, -50%) scale(0)", 2500); 
        }

    </script>
</body>
</html>